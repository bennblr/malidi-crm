# Настройка Telegram бота

## Проблема: Бот не создает заявки

Если бот добавлен в чат, но не создает заявки, проверьте следующие шаги:

## 1. Настройка Webhook

Telegram бот должен получать обновления через webhook. Для этого нужно настроить URL webhook.

### Для локальной разработки (через ngrok):

1. Установите ngrok: https://ngrok.com/download
2. Запустите ngrok туннель:
   ```bash
   ngrok http 3000
   ```
3. Скопируйте HTTPS URL (например: `https://abc123.ngrok.io`)
4. Добавьте в `.env`:
   ```
   WEBHOOK_URL=https://abc123.ngrok.io
   ```
5. Запустите скрипт настройки webhook:
   ```bash
   npm run telegram:setup-webhook
   ```

### Для продакшена:

1. Убедитесь, что ваш сервер доступен из интернета
2. Добавьте в `.env`:
   ```
   WEBHOOK_URL=https://your-domain.com
   ```
3. Запустите скрипт настройки webhook:
   ```bash
   npm run telegram:setup-webhook
   ```

## 2. Проверка настроек

Убедитесь, что в `.env` файле указаны:
- `TELEGRAM_BOT_TOKEN` - токен бота от BotFather
- `WEBHOOK_URL` или `NEXTAUTH_URL` - URL вашего сервера

## 3. Проверка логов

После настройки webhook, отправьте тестовое сообщение в чат. Проверьте логи сервера - должны появиться сообщения:
- `Telegram webhook received:` - входящий запрос
- `Message text:` - текст сообщения
- `Parsed data:` - распарсенные данные
- `Card created successfully:` - успешное создание карточки

## 4. Формат сообщения

Убедитесь, что сообщения в чате соответствуют формату:

```
Приборы:
Алкотестер S/N: 10505217 Динго В-02
_______________________________
Адрес доставки:
Червень Ленинская 54
_______________________________
Контактные данные:
Калько Александр Анатольевич +375336704085 chervenforestry@yandex.by
_______________________________
Организация
Государственное лесохозяйственное учреждение «Червенский лесхоз»
_______________________________
Дата отправки:
2025-12-01
_______________________________
Сообщение заказчика:

_______________________________
AUTOLIGHTEXPRESS ордер № 600000269006
Ордер создан успешно
```

## 5. Проверка webhook

Проверить текущий webhook можно через Telegram Bot API:
```bash
curl https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getWebhookInfo
```

## 6. Альтернатива: Long Polling (для разработки)

Если webhook не работает, можно использовать long polling. Для этого нужно изменить `src/lib/telegram.ts`:

```typescript
bot = new TelegramBot(process.env.TELEGRAM_BOT_TOKEN, { polling: true })
```

И добавить обработчик сообщений в отдельный файл.

## Устранение проблем

- **Webhook не работает**: Убедитесь, что URL доступен из интернета (используйте ngrok для локальной разработки)
- **Сообщения не парсятся**: Проверьте формат сообщения - он должен точно соответствовать примеру выше
- **Ошибки в логах**: Проверьте, что все данные в базе созданы (колонки, приоритеты, системный пользователь)

