# Тестирование Telegram Webhook

## Проблема: Логи не отображаются

Если GET запрос работает, но POST запросы не логируются, выполните следующие шаги:

## Шаг 1: Проверка POST запроса напрямую

Выполните POST запрос к тестовому endpoint:

```bash
curl -X POST https://malidi-crm.onrender.com/api/telegram/test \
  -H "Content-Type: application/json" \
  -d '{"text": "test message"}'
```

Или используйте онлайн инструмент типа Postman/Insomnia для отправки POST запроса.

## Шаг 2: Проверка webhook напрямую

Отправьте тестовое сообщение напрямую в webhook:

```bash
curl -X POST https://malidi-crm.onrender.com/api/telegram/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "message": {
      "message_id": 123,
      "from": {
        "id": 123456789,
        "is_bot": false,
        "first_name": "Test"
      },
      "chat": {
        "id": -1001234567890,
        "title": "Test Chat",
        "type": "supergroup"
      },
      "date": 1234567890,
      "text": "Приборы:\nАлкотестер S/N: 10505217 Динго В-02\n_______________________________\nАдрес доставки:\nЧервень Ленинская 54\n_______________________________\nКонтактные данные:\nКалько Александр Анатольевич +375336704085 chervenforestry@yandex.by\n_______________________________\nОрганизация\nГосударственное лесохозяйственное учреждение «Червенский лесхоз»\n_______________________________\nДата отправки:\n2025-12-01"
    }
  }'
```

## Шаг 3: Проверка логов на Render.com

1. Откройте панель управления Render.com
2. Перейдите в ваш сервис
3. Откройте вкладку "Logs"
4. **ВАЖНО**: Логи обновляются в реальном времени, но могут быть задержки
5. Выполните POST запрос и сразу проверьте логи
6. Ищите записи, начинающиеся с `===`

## Шаг 4: Проверка статуса webhook в Telegram

Проверьте, настроен ли webhook в Telegram:

```bash
curl "https://api.telegram.org/bot8587974702:AAEiDhEvnuJ_TQx4qNlYiEtGSIXSrNF3WS4/getWebhookInfo"
```

Это покажет:
- Текущий URL webhook
- Количество ожидающих обновлений
- Последнюю ошибку (если есть)

## Шаг 5: Настройка webhook

Если webhook не настроен, выполните:

```bash
curl -X POST https://malidi-crm.onrender.com/api/telegram/setup
```

Или откройте в браузере:
```
https://malidi-crm.onrender.com/api/telegram/setup
```
(но это будет GET запрос, нужен POST)

## Важные замечания

1. **Логи на Render.com**: Логи могут отображаться с задержкой до нескольких секунд
2. **Внутренние запросы**: Тестовый endpoint делает внутренний fetch, который может не работать на Render.com из-за особенностей routing
3. **Проверка через внешний инструмент**: Лучше использовать curl или Postman для отправки POST запросов
4. **Telegram webhook**: Telegram отправляет запросы только когда есть новые сообщения в чате

## Диагностика

Если после всех проверок логи все еще не появляются:

1. Проверьте, что приложение запущено на Render.com (не в спящем режиме)
2. Проверьте переменные окружения на Render.com
3. Проверьте, что endpoint доступен (GET запрос работает)
4. Попробуйте отправить реальное сообщение в Telegram чат с ботом
5. Проверьте логи на Render.com через несколько секунд после отправки сообщения

