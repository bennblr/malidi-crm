# Отладка парсера Telegram сообщений

## Проблема: Сообщения не парсятся из Telegram чата

## Шаги для диагностики

### 1. Проверка получения сообщений

Проверьте логи на сервере (Render.com или локально). Должны появиться записи:
- `=== Telegram webhook POST request received ===`
- `Message text: ...`
- `=== Parser: Starting to parse message ===`

Если этих записей нет, значит webhook не настроен или сообщения не доходят до сервера.

### 2. Проверка формата сообщения

Парсер ожидает следующий формат:

```
Приборы:
[описание приборов]
_______________________________
Адрес доставки:
[адрес]
_______________________________
Контактные данные:
[контакты]
_______________________________
Организация
[название организации]
_______________________________
Дата отправки:
[дата]
_______________________________
Сообщение заказчика:
[сообщение]
_______________________________
AUTOLIGHTEXPRESS ордер № [номер]
```

### 3. Улучшения парсера

Парсер был улучшен для обработки:
- Различных вариантов разделителей (подчеркивания, дефисы, пробелы)
- Различных вариантов написания заголовков
- Сообщений с пропущенными полями
- Сообщений с дополнительными пробелами

### 4. Тестирование парсера

Используйте тестовый endpoint для проверки:

```bash
curl -X POST https://malidi-crm.onrender.com/api/telegram/test \
  -H "Content-Type: application/json" \
  -d '{"text": "ваше тестовое сообщение"}'
```

Или отправьте реальное сообщение в Telegram чат с ботом.

### 5. Проверка логов парсера

В логах должны появиться детальные записи:
- `Parser: Starting to parse message`
- `Parser: Found instruments: ...`
- `Parser: Found delivery address: ...`
- `Parser: Found contacts: ...`
- `Parser: Found organization: ...`
- `Parser: Successfully parsed all required fields`

Если какое-то поле не найдено, будет запись:
- `Parser: Missing required fields: [список полей]`

### 6. Возможные проблемы

1. **Webhook не настроен**
   - Решение: Выполните `curl -X POST https://malidi-crm.onrender.com/api/telegram/setup`

2. **Сообщения не доходят до сервера**
   - Проверьте, что приложение запущено
   - Проверьте, что URL webhook правильный
   - Проверьте логи на Render.com

3. **Формат сообщения не соответствует ожидаемому**
   - Парсер теперь более гибкий, но если формат сильно отличается, нужно будет адаптировать регулярные выражения

4. **Обязательные поля отсутствуют**
   - Парсер требует: Приборы, Адрес доставки, Контакты, Организация
   - Если какое-то поле отсутствует, заявка не будет создана

### 7. Отладка через логи

Все операции парсера логируются. Проверьте логи на:
- Получение сообщения
- Начало парсинга
- Найденные поля
- Отсутствующие поля
- Ошибки парсинга

## Формат сообщения для успешного парсинга

Минимальный формат, который должен быть распознан:

```
Приборы:
Алкотестер S/N: 10505217

Адрес доставки:
Червень Ленинская 54

Контактные данные:
Калько Александр +375336704085

Организация
Червенский лесхоз
```

Разделители могут быть любыми (подчеркивания, дефисы, пробелы) или вообще отсутствовать.

